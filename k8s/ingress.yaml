---
# Ingress with nginx-ingress controller
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: llm-benchmark-api
  namespace: llm-benchmark
  labels:
    app: llm-benchmark-exchange
    component: api
  annotations:
    # Ingress class
    kubernetes.io/ingress.class: "nginx"

    # SSL/TLS
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://llm-benchmark.example.com,https://app.llm-benchmark.example.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/cors-max-age: "86400"

    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "60"
    nginx.ingress.kubernetes.io/limit-connections: "100"
    nginx.ingress.kubernetes.io/limit-rpm: "3600"

    # Request buffering and timeouts
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"

    # Compression
    nginx.ingress.kubernetes.io/enable-gzip: "true"
    nginx.ingress.kubernetes.io/gzip-types: "application/json,application/xml,text/plain,text/css,text/javascript"

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: geolocation=(), microphone=(), camera=()";

    # Backend protocol
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"

    # Affinity
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "llm-benchmark-affinity"
    nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"

    # Monitoring
    nginx.ingress.kubernetes.io/enable-access-log: "true"
    nginx.ingress.kubernetes.io/enable-rewrite-log: "false"

spec:
  tls:
  - hosts:
    - api.llm-benchmark.example.com
    secretName: llm-benchmark-api-tls
  rules:
  - host: api.llm-benchmark.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: llm-benchmark-api
            port:
              name: http

---
# Alternative: AWS ALB Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: llm-benchmark-api-alb
  namespace: llm-benchmark
  labels:
    app: llm-benchmark-exchange
    component: api
  annotations:
    # ALB Ingress Controller
    kubernetes.io/ingress.class: "alb"
    alb.ingress.kubernetes.io/scheme: "internet-facing"
    alb.ingress.kubernetes.io/target-type: "ip"
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"

    # Certificate
    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:us-east-1:123456789012:certificate/12345678-1234-1234-1234-123456789012"

    # Health check
    alb.ingress.kubernetes.io/healthcheck-path: "/health"
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "2"

    # Stickiness
    alb.ingress.kubernetes.io/target-group-attributes: "stickiness.enabled=true,stickiness.lb_cookie.duration_seconds=3600"

    # WAF
    # alb.ingress.kubernetes.io/wafv2-acl-arn: "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/..."

    # Security groups
    alb.ingress.kubernetes.io/security-groups: "sg-12345678"

    # Tags
    alb.ingress.kubernetes.io/tags: "Environment=production,Team=platform"

spec:
  rules:
  - host: api.llm-benchmark.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: llm-benchmark-api
            port:
              name: http

---
# GCP GKE Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: llm-benchmark-api-gke
  namespace: llm-benchmark
  labels:
    app: llm-benchmark-exchange
    component: api
  annotations:
    kubernetes.io/ingress.class: "gce"
    kubernetes.io/ingress.global-static-ip-name: "llm-benchmark-ip"
    networking.gke.io/managed-certificates: "llm-benchmark-cert"
    kubernetes.io/ingress.allow-http: "false"

spec:
  rules:
  - host: api.llm-benchmark.example.com
    http:
      paths:
      - path: /*
        pathType: ImplementationSpecific
        backend:
          service:
            name: llm-benchmark-api
            port:
              name: http

---
# GKE ManagedCertificate (for GCP)
apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: llm-benchmark-cert
  namespace: llm-benchmark
spec:
  domains:
  - api.llm-benchmark.example.com
